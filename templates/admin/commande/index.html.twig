{% extends 'admin/layout.html.twig' %}

{% block title %}Commandes{% endblock %}
{% block page_title %}Commandes{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Admin</a></li>
  <li class="breadcrumb-item active">Commandes</li>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="h5 text-white mb-1">Gestion des commandes</h2>
      <p class="text-muted mb-0">Suivi des commandes d’achat et de location.</p>
    </div>

    <span class="badge rounded-pill bg-primary">
      {{ commandes|length }} commandes
    </span>
  </div>

  <div class="card glass-panel border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead class="text-muted">
            <tr>
              <th class="ps-3">ID</th>
              <th>Client</th>
              <th>Voiture</th>
              <th>Type</th>
              <th>Montant</th>
              <th>Date</th>
              <th>Statut</th>
              <th class="text-end pe-3">Actions</th>
            </tr>
          </thead>

          <tbody>
          {% for commande in commandes %}
            {# voitures de la commande #}
            {% set lignes = commande.lignesCommande|default([]) %}
            {% set firstLine = lignes|first %}
            {% set firstCar = firstLine ? firstLine.voiture : null %}
            {% set moreCount = (lignes|length > 1) ? (lignes|length - 1) : 0 %}

            {% set c = commande.client %}
            {% set st = (commande.statut ?? '')|upper %}

            <tr>
              <td class="ps-3 fw-bold">#{{ commande.id }}</td>

              {# Client #}
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span class="avatar-circle d-inline-flex align-items-center justify-content-center"
                        style="width:32px;height:32px;background:rgba(40,167,69,.18);color:#fff;">
                    <i class="fas fa-user"></i>
                  </span>

                  <div>
                    <div class="fw-semibold text-light">
                      {{ c ? (c.nom ?? c.prenom ?? c.email ?? 'Client') : '—' }}
                    </div>
                    <div class="small text-secondary">
                      {{ c ? (c.email ?? '') : '' }}
                    </div>
                  </div>
                </div>
              </td>

              {# Voiture #}
              <td>
                {% if firstCar %}
                  <div class="fw-semibold text-light">
                    {{ firstCar.marque }} {{ firstCar.modele }}
                  </div>
                  <div class="small text-secondary">
                    {{ firstCar.matricule ?? '' }}
                    {% if moreCount > 0 %}
                      <span class="ms-2 badge rounded-pill bg-secondary">+{{ moreCount }}</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="text-secondary">—</span>
                {% endif %}
              </td>

              {# Type #}
              <td>
                <span class="badge rounded-pill {{ commande.type == 'achat' ? 'bg-primary' : 'bg-info text-dark' }}">
                  {{ commande.type|capitalize }}
                </span>
              </td>

              {# Montant #}
              <td class="fw-semibold text-light">
                {{ commande.prixCmd|number_format(2, '.', ' ') }} DT
              </td>

              {# Date #}
              <td class="text-secondary">
                {{ commande.date ? commande.date|date('d/m/Y H:i') : '—' }}
              </td>

              {# Statut #}
              <td>
                <span class="badge rounded-pill
                  {% if st == 'LIVREE' %} bg-success
                  {% elseif st == 'VALIDEE' %} bg-primary
                  {% elseif st == 'ANNULEE' %} bg-danger
                  {% else %} bg-warning text-dark
                  {% endif %}">
                  {{ st ? st|replace({'_':' '}) : '—' }}
                </span>

                {# Select statut (POST) #}
                <form method="post"
                      action="{{ path('admin_commande_status', {id: commande.id}) }}"
                      class="mt-2">

                  <select name="statut"
                          class="form-select form-select-sm bg-dark text-light border border-secondary status-{{ st }}"
                          onchange="this.form.submit()">

                    <option value="EN_ATTENTE" {{ st == 'EN_ATTENTE' ? 'selected' : '' }}>En attente</option>
                    <option value="VALIDEE" {{ st == 'VALIDEE' ? 'selected' : '' }}>Validée</option>
                    <option value="LIVREE" {{ st == 'LIVREE' ? 'selected' : '' }}>Livrée</option>
                    <option value="ANNULEE" {{ st == 'ANNULEE' ? 'selected' : '' }}>Annulée</option>

                  </select>
                </form>
              </td>

              {# Actions #}
              <td class="text-end pe-3">
                <form method="post"
                      action="{{ path('admin_commande_delete', {id: commande.id}) }}"
                      onsubmit="return confirm('Supprimer cette commande ?');"
                      class="d-inline">

                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commande.id) }}">

                  <button class="btn btn-sm btn-outline-danger" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>

                </form>
              </td>
            </tr>

          {% else %}
            <tr>
              <td colspan="8" class="text-center py-5 text-muted">
                <i class="fas fa-box-open me-2"></i>Aucune commande trouvée.
              </td>
            </tr>
          {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>

</div>

{# ✅ Style optionnel : bordure colorée du select selon statut #}
<style>
  select.status-EN_ATTENTE { border-left: 4px solid #ffc107 !important; }
  select.status-VALIDEE   { border-left: 4px solid #0d6efd !important; }
  select.status-LIVREE    { border-left: 4px solid #198754 !important; }
  select.status-ANNULEE   { border-left: 4px solid #dc3545 !important; }
</style>
{% endblock %}
